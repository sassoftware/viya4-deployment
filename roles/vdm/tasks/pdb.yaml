---
- name: Get componenets
  find:
    paths: "{{ DEPLOY_DIR }}/{{ BUNDLE_ROOT }}/{{ BASES_LOC }}/{{ COMPONENTS_DIR }}"
    file_type: directory
    recurse: no
  register: resource_files
  tags:
    - install
    - uninstall
    - upgrade

- name: Make resource files writeable
  file:
    path: "{{ item.path }}/resources.yaml"
    mode: '666'
  with_items: "{{ resource_files.files }}"
  no_log: yes
  tags:
    - install
    - uninstall
    - upgrade

- name: Patch resources
  blockinfile:
    block: |
      ---
      apiVersion: policy/v1beta1
      kind: PodDisruptionBudget
      metadata:
        name: {{ item.path|basename }}
      spec:
        minAvailable: 1
        selector:
          matchExpressions:
            - {key: app, operator: In, values: [{{ item.path|basename }}]}
    path: "{{ item.path }}/resources.yaml"
    marker: "# {mark} VDM MANAGED BLOCK"
  with_items: "{{ resource_files.files }}"
  no_log: yes
  tags:
    - install
    - uninstall
    - upgrade

- name: Make resource files not writeable
  file:
    path: "{{ item.path }}/resources.yaml"
    mode: '444'
  with_items: "{{ resource_files.files }}"
  no_log: yes
  tags:
    - install
    - uninstall
    - upgrade