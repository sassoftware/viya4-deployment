---
- name: orchestration - Set orchestration tooling facts
  set_fact:
    ORCHESTRATION_TOOLING_DIRECTORY: "{{ tmpdir.path }}/orchestration"
    ORCHESTRATION_TOOLING_ARCHIVE: "{{ tmpdir.path}}/orchestration.tar"
    ORCHESTRATION_TOOLING_INSTALL_MANIFEST: "{{ DEPLOY_DIR }}/SASDeployment.yaml"
    ORCHESTRATION_TOOLING_INSTALL_MANIFESTS_DIRECTORY: "{{ tmpdir.path }}/orchestration/manifests"
    ORCHESTRATION_TOOLING_UNINSTALL_MANIFEST: "{{ DEPLOY_DIR }}/uninstall.yaml"
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Find orchestration tooling image
  set_fact:
    ORCHESTRATION_IMAGE: "{{ (lookup('file', '{{ DEPLOY_DIR }}/sas-bases/.orchestration/images.yaml')|from_yaml).spec.images['sas-orchestration'] }}"
  when:
    - ORCHESTRATION_IMAGE is not defined
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Download orchestration tooling image
  command: |
    skopeo copy docker://{{ V4_CFG_CR_HOST }}/{{ ORCHESTRATION_IMAGE }} oci-archive:{{ ORCHESTRATION_TOOLING_ARCHIVE }} --src-creds {{ V4_CFG_CR_USER }}:{{ V4_CFG_CR_PASSWORD }}
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Create orchestration tooling directory
  file:
    path: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
    state: directory
    mode: "0700"
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Extract orchestration tooling
  block:
    - name: orchestration - Extract orchestration tooling archive
      unarchive:
        src: "{{ ORCHESTRATION_TOOLING_ARCHIVE }}"
        dest: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
    - name: orchestration - Extract orchestration tooling layers
      shell:
        chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
        cmd: |
          manifest=$(cat index.json | jq -r '.manifests[0].digest' | cut -d: -f2)
          cat "blobs/sha256/$manifest" | jq -r '.layers[].digest' | cut -d: -f2 | while read layer; do tar -xf "blobs/sha256/$layer"; chmod -R 700 * .; done;
    - name: orchestration - Extract orchestration tooling path
      shell:
        chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
        cmd: |
          manifest=$(cat index.json | jq -r '.manifests[0].digest' | cut -d: -f2)
          config=$(cat blobs/sha256/$manifest | jq -r '.config.digest' | cut -d: -f2)
          cat blobs/sha256/$config | jq -r '.config.Env[]' | grep PATH= | cut -d= -f2
      register: orchestration_path
    - name: orchestration - Prepend path with tooling directory
      set_fact:
        path_list: "{{ path_list | default([]) + [''.join((ORCHESTRATION_TOOLING_DIRECTORY,item))] }}"
      loop: "{{ orchestration_path.stdout.split(':') | list}}"
    - name: orchestration - Set orchestration tooling path
      set_fact:
        ORCHESTRATION_TOOLING_PATH: "{{ path_list | join(':') }}"
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Find order cadence release
  set_fact:
    V4_CFG_CADENCE_RELEASE: "{{ (lookup('file', '{{ DEPLOY_DIR }}/sas-bases/.orchestration/cadence.yaml')|from_yaml).spec.release }}"
  tags:
    - install
    - uninstall
    - update

- name: orchestration - Generate SAS Viya deployment manifest
  environment:
    PATH: "{{ ORCHESTRATION_TOOLING_PATH }}"
  command:
    cmd: |
      orchestration create sas-deployment-cr
        --cadence-name "{{ V4_CFG_CADENCE_NAME }}"
        --cadence-version "{{ V4_CFG_CADENCE_VERSION }}"
        --cadence-release "{{ V4_CFG_CADENCE_RELEASE }}"
        --image-registry "{{ V4_CFG_CR_HOST }}"
        --deployment-data "{{ tmpdir.path }}/certs.zip"
        --user-content "{{ DEPLOY_DIR }}"
  args:
    chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
  tags:
    - install
    - update
  register: sasdeployment

- name: orchestration - Write SAS Viya deployment manifest
  copy:
    content: "{{ sasdeployment.stdout }}"
    dest: "{{ ORCHESTRATION_TOOLING_INSTALL_MANIFEST }}"
    mode: "0660"
  tags:
    - install
    - update

- name: orchestration - Write SAS Viya deployment manifests into orchestration tooling directory
  block:
    - name: orchestration - Create manifests directory in orchestration tooling directory
      file:
        path: "{{ ORCHESTRATION_TOOLING_INSTALL_MANIFESTS_DIRECTORY }}"
        state: directory
        mode: "0700"
    - name: orchestration - Split SAS Viya deployment manifest into orchestration directory
      command:
        chdir: "{{ ORCHESTRATION_TOOLING_INSTALL_MANIFESTS_DIRECTORY }}"
        cmd: |
          csplit "{{ ORCHESTRATION_TOOLING_INSTALL_MANIFEST }}"
              --prefix='SASDeployment.'
              --suffix-format='%03d.yaml'
              --elide-empty-files
              '/^----*$/' '{*}'
  when:
    - DEPLOYMENT_OPERATOR_ENABLED == False
  tags:
    - install
    - update

- name: orchestration - Create SAS Viya uninstall manifest
  block:
    - name: orchestration - Generate SAS Viya uninstall manifest
      environment:
        PATH: "{{ ORCHESTRATION_TOOLING_PATH }}"
      command:
        cmd: |
          orchestration create sas-deployment-cr
            --cadence-name "{{ V4_CFG_CADENCE_NAME }}"
            --cadence-version "{{ V4_CFG_CADENCE_VERSION }}"
            --cadence-release "{{ V4_CFG_CADENCE_RELEASE }}"
            --image-registry "{{ V4_CFG_CR_HOST }}"
            --deployment-data "{{ tmpdir.path }}/certs.zip"
            --user-content "{{ DEPLOY_DIR }}"
      args:
        chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
      register: sasdeployment
    - name: orchestration - Write SAS Viya uninstall manifest
      copy:
        content: "{{ sasdeployment.stdout }}"
        dest: "{{ ORCHESTRATION_TOOLING_UNINSTALL_MANIFEST }}"
        mode: "0660"
  when:
    - DEPLOYMENT_OPERATOR_ENABLED
  tags:
    - uninstall

- name: orchestration - Create SAS Viya uninstall manifest
  block:
    - name: orchestration - Generate SAS Viya uninstall manifest
      environment:
        PATH: "{{ ORCHESTRATION_TOOLING_PATH }}"
      command:
        cmd: |
          kustomize build {{ DEPLOY_DIR }}
      args:
        chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
      register: uninstall
    - name: orchestration - Write SAS Viya uninstall manifest
      copy:
        content: "{{ uninstall.stdout }}"
        dest: "{{ ORCHESTRATION_TOOLING_UNINSTALL_MANIFEST }}"
        mode: "0660"
  when:
    - DEPLOYMENT_OPERATOR_ENABLED == False
  tags:
    - uninstall
