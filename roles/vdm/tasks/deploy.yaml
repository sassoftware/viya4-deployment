# Copyright Â© 2020-2024, SAS Institute Inc., Cary, NC, USA. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

---
- name: Deploy - Apply SAS Viya deployment - Deployment Operator
  kubernetes.core.k8s:
    src: "{{ DEPLOY_DIR }}/sasdeployment.yaml"
    state: present
    namespace: "{{ NAMESPACE }}"
    kubeconfig: "{{ KUBECONFIG }}"
  when:
    - V4_DEPLOYMENT_OPERATOR_ENABLED
  tags:
    - install
    - update
    - cas-onboard

- name: Deploy - Apply SAS Viya deployment - sas-orchestration
  when:
    - not V4_DEPLOYMENT_OPERATOR_ENABLED
  tags:
    - install
    - update
    - cas-onboard
  block:
    - name: Deploy - Deploy SAS Viya - sas-orchestration - Docker
      environment:
        PATH: "{{ ORCHESTRATION_TOOLING_PATH + ':' + env_path }}"
        KUBECONFIG: "{{ KUBECONFIG }}"
        EXPERIMENTAL_FEATURE_DEPLOY_MANIFEST: "true"
      command: |
        orchestration deploy manifest
             --namespace "{{ NAMESPACE }}"
             --manifest "{{ DEPLOY_DIR }}/site.yaml"
             --deployment-dir "{{ DEPLOY_DIR }}/sas-bases"
      args:
        chdir: "{{ ORCHESTRATION_TOOLING_DIRECTORY }}"
      when:
        - deployment_tooling == "docker"
    - name: Deploy - Deploy SAS Viya - sas-orchestration - Ansible
      ansible.builtin.shell: >
        docker run --rm
        --user="{{ UID_GID }}"
        --name "orchestration_{{ lookup('password', '/dev/null chars=ascii_lowercase length=8') }}"
        --env KUBECONFIG="/config/kubeconfig"
        --env EXPERIMENTAL_FEATURE_DEPLOY_MANIFEST=true
        --volume "{{ KUBECONFIG }}:/config/kubeconfig"
        --volume "{{ DEPLOY_DIR }}:/deploy_dir"
        "{{ V4_CFG_CR_HOST }}/{{ ORCHESTRATION_IMAGE }}"
        deploy manifest
        --namespace {{ NAMESPACE }}
        --manifest /deploy_dir/site.yaml
        --deployment-dir /deploy_dir/sas-bases
      when:
        - deployment_tooling == "ansible"

- name: Deploy - Uninstall postgresclusters
  environment:
    KUBECONFIG: "{{ KUBECONFIG }}"
  ansible.builtin.shell: >
    kubectl -n {{ NAMESPACE }} delete postgresclusters --selector="sas.com/deployment=sas-viya" --ignore-not-found=true
  ignore_errors: true
  when:
    - V4_CFG_CADENCE_VERSION is version('2022.10', ">=") or V4_CFG_CADENCE_NAME|lower == "fast"
    - internal_postgres
  tags:
    - uninstall

- name: Deploy - Remove Viya
  block:
    - name: Deploy - Remove Viya - Deployment Operator
      kubernetes.core.k8s:
        state: absent
        src: "{{ ORCHESTRATION_TOOLING_UNINSTALL_MANIFEST }}"
        wait: true
        wait_timeout: 600
        namespace: "{{ NAMESPACE }}"
        kubeconfig: "{{ KUBECONFIG }}"
      ignore_errors: true
      when:
        - V4_DEPLOYMENT_OPERATOR_ENABLED
    - name: Deploy - Remove Viya - sas-orchestration
      kubernetes.core.k8s:
        state: absent
        src: "{{ DEPLOY_DIR }}/site.yaml"
        namespace: "{{ NAMESPACE }}"
        kubeconfig: "{{ KUBECONFIG }}"
      ignore_errors: true
      when:
        - not V4_DEPLOYMENT_OPERATOR_ENABLED
  tags:
    - uninstall

- name: Deploy - Delete namespace
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ NAMESPACE }}"
    wait: true
    wait_timeout: 600
    kubeconfig: "{{ KUBECONFIG }}"
    state: absent
  tags:
    - uninstall
