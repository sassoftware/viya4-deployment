- set_fact:
    V4_CFG_DEPLOYMENT_URL_PREFIX: 'http://'
    V4_CFG_DEPLOYMENT_URL_PORT: ':80'
  tags:
    - install
    - uninstall
    - upgrade

- include_tasks: vdm_loader.yaml
  vars:
    resources:
      - "{{ VDM_RESOURCES_PATH }}/consul-ui.yaml"
  when: 
    - V4_CFG_ENABLE_CONSUL_UI
  tags:
    - install
    - uninstall
    - upgrade

- name: Set TLS Facts
  include_tasks: vdm_loader.yaml
  vars:
    resources: 
      - "{{ BUNDLE_ROOT }}/overlays/network/ingress/security"
      - '{{ VDM_RESOURCES_PATH }}/consul-and-cas-ingress.yaml'
      - '{{ VDM_RESOURCES_PATH }}/nginx-tls.yaml'
    transformers: 
      - "{{ BUNDLE_ROOT }}/overlays/network/ingress/security/patches/product-tls-patches.yaml"
      - '{{ VDM_TRANSFORMERS_PATH }}/networking-k8s-io-ingress-patch.yaml'
      - "{{ BUNDLE_ROOT }}/overlays/network/ingress/security/patches/backend-tls-patches.yaml"
      - "{{ BUNDLE_ROOT }}/examples/security/user-patches-tls.yaml"
    generators: 
      - "{{ BUNDLE_ROOT }}/examples/security/user-custom-ingress-cert-generator.yaml"
      - "{{ BUNDLE_ROOT }}/examples/security/additional-ca-certificates-configmap.yaml"
      - "{{ BUNDLE_ROOT }}/overlays/network/ingress/security/generator-merges/backend-tls-generator-merges.yaml"
  when: 
    - V4_CFG_CONFIGURE_TLS
  tags:
    - install
    - uninstall
    - upgrade

- set_fact: 
    V4_CFG_DEPLOYMENT_URL_PREFIX: 'https://'
    V4_CFG_DEPLOYMENT_URL_PORT: ':443'
    CERT: "{{ lookup('file', V4_CFG_TLS_CERT) | b64encode }}"
    KEY: "{{ lookup('file', V4_CFG_TLS_KEY) | b64encode }}"
  when:
    - V4_CFG_CONFIGURE_TLS
    - V4_CFG_TLS_CERT is not none
    - V4_CFG_TLS_KEY is not none
  tags:
    - install
    - uninstall
    - upgrade

- name: Add tls transformer
  include_tasks: vdm_loader.yaml
  vars:
    transformers: 
      - "{{ VDM_TRANSFORMERS_PATH }}/tls_config.yaml"
  when: 
    - V4_CFG_CONFIGURE_TLS
    - V4_CFG_TLS_CERT is not none
    - V4_CFG_TLS_KEY is not none
  tags:
    - install
    - uninstall
    - upgrade