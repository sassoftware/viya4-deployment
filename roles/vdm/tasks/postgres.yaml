- name: Set Postgres Facts (global)
  include_tasks: vdm_loader.yaml
  vars:
    generators: 
      - "{{ VDM_GENERATORS_PATH }}/postgres-sas-user.yaml"
  when: 
    - V4_CFG_POSTGRES_TYPE is not none
  tags:
    - install
    - uninstall
    - upgrade

- name: Create pg-storage-class-transformer
  copy:
    src: "{{DEPLOY_DIR}}/{{ BUNDLE_ROOT }}/examples/crunchydata/storageclass/storage-class-transformer.yaml"
    dest: "{{DEPLOY_DIR}}/{{ VDM_TRANSFORMERS_PATH }}/pg-storage-class-transformer.yaml"
    mode: '0644'
  when: 
    - V4_CFG_POSTGRES_TYPE == 'internal'
  tags:
    - install
    - uninstall
    - upgrade

- name: Patch pg-storage-class-transformer
  replace:
    path: "{{DEPLOY_DIR}}/{{ VDM_TRANSFORMERS_PATH }}/pg-storage-class-transformer.yaml"
    regexp: "trident"
    replace: "{{ V4_CFG_RWO_STORAGE_CLASS }}"
  when: 
    - V4_CFG_POSTGRES_TYPE == 'internal'
  tags:
    - install
    - uninstall
    - upgrade

- name: Set Postgres Facts (internal)
  include_tasks: vdm_loader.yaml
  vars:
    resources: 
     - "{{ BUNDLE_ROOT }}/overlays/internal-postgres"
     - "{{ BUNDLE_ROOT }}/overlays/crunchydata"
    transformers: 
      - "{{ BUNDLE_ROOT }}/overlays/internal-postgres/internal-postgres-transformer.yaml"
      - "{{ VDM_TRANSFORMERS_PATH }}/pg-storage-class-transformer.yaml"
  when: 
    - V4_CFG_POSTGRES_TYPE == 'internal'
  tags:
    - install
    - uninstall
    - upgrade

- name: Set Postgres Facts (external)
  include_tasks: vdm_loader.yaml
  vars:
    transformers: 
      - "{{ BUNDLE_ROOT }}/overlays/external-postgres/external-postgres-transformer.yaml"
    generators: 
      - "{{ VDM_GENERATORS_PATH }}/sas-go-config.yaml"
      - "{{ VDM_GENERATORS_PATH }}/sas-postgres-config.yaml"
  when: 
    - V4_CFG_POSTGRES_TYPE == 'external'
  tags:
    - install
    - uninstall
    - upgrade