---
- name: update tenant cas customizations
  block:
    - name: tenant cas - MPP workers
      command:
        cmd: "{{ DEPLOY_DIR }}/site-config/create-cas-server.sh --tenant {{ tenant | lower }} \
             --output {{ DEPLOY_DIR }}/site-config \
             --workers {{ settings.V4MT_CFG_CAS_WORKER_COUNT if (settings.V4MT_CFG_CAS_WORKER_COUNT is defined and \
                                                                 settings.V4MT_CFG_CAS_WORKER_COUNT is not none ) else 0 }} \
             --backup {{ 1 if (settings.V4MT_CFG_CAS_ENABLE_BACKUP_CONTROLLER is defined) and \
                              (settings.V4MT_CFG_CAS_ENABLE_BACKUP_CONTROLLER|bool == True) else 0 }}"

    - name: tenant cas user-defined resources - copy template
      copy:
        src: "{{ role_path }}/templates/cas-manage-cpu-and-memory.yaml"
        dest: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default/cas-manage-cpu-and-memory.yaml"
        mode: "0660"
      when:
        - settings.V4MT_CFG_CAS_RAM is defined and settings.V4MT_CFG_CAS_RAM is not none
        - settings.V4MT_CFG_CAS_CORES is defined and settings.V4MT_CFG_CAS_CORES is not none

    - name: tenant cas user-defined resources - update
      replace:
        path: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default/cas-manage-cpu-and-memory.yaml"
        regexp: "{{ outer_item.regexp }}"
        replace: "{{ outer_item.replace }}"
      with_items:
        - { regexp: '{% raw %}{{ AMOUNT-OF-RAM }}{% endraw %}', replace: '{{ settings.V4MT_CFG_CAS_RAM }}' }
        - { regexp: '{% raw %}{{ NUMBER-OF-CORES }}{% endraw %}', replace: '{{ settings.V4MT_CFG_CAS_CORES }}' }
        - { regexp: '{% raw %}{{ NAME-OF-SERVER }}{% endraw %}', replace: '{{ tenant | lower }}-default' }
      loop_control:
        loop_var: outer_item
      when:
        - settings.V4MT_CFG_CAS_RAM is defined and settings.V4MT_CFG_CAS_RAM is not none
        - settings.V4MT_CFG_CAS_CORES is defined and settings.V4MT_CFG_CAS_CORES is not none

    - name: add tenant cas user-defined resources to kustomization
      lineinfile:
        path: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default/kustomization.yaml"
        insertafter: "transformers:"
        line: "- cas-manage-cpu-and-memory.yaml"
      when:
        - settings.V4MT_CFG_CAS_RAM is defined and settings.V4MT_CFG_CAS_RAM is not none
        - settings.V4MT_CFG_CAS_CORES is defined and settings.V4MT_CFG_CAS_CORES is not none

    - name: tenant cas - external services copy template
      copy:
        src: "{{ role_path }}/templates/cas-enable-external-services.yaml"
        dest: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default"
        mode: "0660"
      when:
        - settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is defined and settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is true
        - settings.V4MT_LOADBALANCER_SOURCE_RANGES is defined and settings.V4MT_LOADBALANCER_SOURCE_RANGES is not none

    - name: tenant cas external services - update
      replace:
        path: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default/cas-enable-external-services.yaml"
        regexp: "{{ outer_item.regexp }}"
        replace: "{{ outer_item.replace }}"
      with_items:
        - { regexp: '{% raw %}{{ LOADBALANCER_SOURCE_RANGES }}{% endraw %}', replace: '{{ settings.V4MT_LOADBALANCER_SOURCE_RANGES }}' }
        - { regexp: '{% raw %}{{ NAME-OF-SERVER }}{% endraw %}', replace: '{{ tenant | lower }}-default' }
      loop_control:
        loop_var: outer_item
      when:
        - settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is defined and settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is true
        - settings.V4MT_LOADBALANCER_SOURCE_RANGES is defined and settings.V4MT_LOADBALANCER_SOURCE_RANGES is not none

    - name: add tenant cas external services to kustomization
      lineinfile:
        path: "{{ DEPLOY_DIR }}/site-config/cas-{{ tenant | lower }}-default/kustomization.yaml"
        insertafter: "transformers:"
        line: "- cas-enable-external-services.yaml"
      when:
        - settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is defined and settings.V4MT_CFG_CAS_ENABLE_LOADBALANCER is true
        - settings.V4MT_LOADBALANCER_SOURCE_RANGES is defined and settings.V4MT_LOADBALANCER_SOURCE_RANGES is not none

  when: V4MT_TENANT_IDS is search(tenant | lower)
  tags:
    - onboard
