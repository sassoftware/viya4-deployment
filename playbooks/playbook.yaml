- hosts: localhost
  connection: local
  roles:
    - common
  tasks:
    - add_host:
        hostname: "{{ JUMP_SVR_HOST }}"
        ansible_ssh_user: "{{ JUMP_SVR_USER }}"
        ansible_ssh_private_key_file: "{{ JUMP_SVR_PRIVATE_KEY }}"
        ansible_ssh_common_args: "-o UserKnownHostsFile=/dev/null"
        groups:
          - "jump"
      when:
        - V4_CFG_MANAGE_STORAGE is defined
        - V4_CFG_MANAGE_STORAGE
        - JUMP_SVR_HOST is defined
        - JUMP_SVR_USER is defined
        - JUMP_SVR_PRIVATE_KEY is defined
      tags:
        - vdm

- hosts: "jump"
  become: yes
  become_user: root
  tasks:
    - file:
        state: directory
        path: "/mnt/viya-share/{{ NAMESPACE }}/{{item}}"
        owner: "nobody"
        group: "nobody"
        mode: "0777"
      with_items:
        - bin
        - homes
        - data
        - astores
      tags:
        - vdm

- hosts: localhost
  connection: local
  tasks:
    - name: baseline role
      include_role:
        name: baseline
        public: yes
      tags:
        - baseline
    - name: persistence role
      include_role:
        name: persistence
        public: yes
      tags:
        - vdm
    - include_vars:
        file: "{{DEPLOY_DIR}}/site-config/defaults.yaml"
      when: CONFIG is not defined
      tags:
        - vdm
    - name: vdm role
      include_role:
        name: vdm
      tags:
        - vdm
    - name: monitoring role
      include_role:
        name: monitoring
      vars:
        tls_enable: "{{ V4_CFG_TLS_MODE != 'disabled' }}"
        base_domain: "{{ V4_CFG_BASE_DOMAIN }}"
        namespace: "{{ NAMESPACE }}"
      tags:
        - cluster-monitoring
        - cluster-logging
        - viya-monitoring
    - name: Delete tmp files
      file:
        path: "{{ item.path }}"
        state: absent
      when:
        - item is defined
        - item.path is defined
      with_items:
        - tmp_kubeconfig
        - tmp_ssh_key
      tags:
        - vdm
        - baseline
  vars:
    kubeconfig: "{{ KUBE }}"
    loadBalancerSourceRanges: "{{ LOADBALANCER_SOURCE_RANGES }}"
    user: "{{ USER }}"
    password: "{{ PASSWORD }}"
